<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Smart Diff (Gradient Overlay Delete)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <style>
        /* ê¸°ë³¸ ë¦¬ì…‹ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* --- ì‚¬ì´ë“œë°” --- */
        .sidebar {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100vh;
            background-color: #ffffff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 1000;
            transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .sidebar.open { left: 0; }

        .history-toggle-btn {
            position: absolute; top: 20px; left: 20px; z-index: 500;
            background-color: #343a40; color: white; border: none; padding: 10px 15px;
            border-radius: 30px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .history-toggle-btn:hover { background-color: #23272b; transform: scale(1.05); }

        .sidebar-header {
            padding: 20px; border-bottom: 1px solid #eee; background-color: #f8f9fa;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-header h3 { margin: 0; font-size: 18px; color: #333; }
        .btn-close-sidebar { background: none; border: none; font-size: 20px; cursor: pointer; color: #888; }
        .btn-close-sidebar:hover { color: #333; }

        .btn-clear {
            margin-top: 10px; width: 100%; padding: 8px; font-size: 12px;
            background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;
        }

        .history-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        
        /* [ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .history-item {
            position: relative; 
            padding: 15px; 
            border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; 
            transition: background 0.2s;
            overflow: hidden; /* ì˜¤ë²„ë ˆì´ê°€ íŠ€ì–´ë‚˜ê°€ì§€ ì•Šê²Œ */
        }
        .history-item:hover { background-color: #f8f9fa; }
        .history-item.active { background-color: #e7f1ff; border-left: 4px solid #0069d9; }
        
        /* [í•µì‹¬] ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ & ì‚­ì œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .delete-overlay {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px; /* ê·¸ë¼ë°ì´ì…˜ ë„ˆë¹„ */
            /* ì™¼ìª½(íˆ¬ëª…) -> ì˜¤ë¥¸ìª½(í°ìƒ‰/ë°°ê²½ìƒ‰) ê·¸ë¼ë°ì´ì…˜ */
            background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,1) 40%);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            transition: opacity 0.2s ease-in-out;
            padding-left: 20px; /* ê·¸ë¼ë°ì´ì…˜ ì‹œì‘ì  í™•ë³´ */
        }

        /* Active ìƒíƒœì¼ ë•Œì˜ ì˜¤ë²„ë ˆì´ ìƒ‰ìƒ ì¡°ì • (ë°°ê²½ìƒ‰ì¸ #e7f1ffì™€ ë§ì¶¤) */
        .history-item.active .delete-overlay {
            background: linear-gradient(to right, rgba(231, 241, 255, 0), rgba(231, 241, 255, 1) 40%);
        }
        /* Hover ìƒíƒœì¼ ë•Œì˜ ì˜¤ë²„ë ˆì´ ìƒ‰ìƒ ì¡°ì • (ë°°ê²½ìƒ‰ì¸ #f8f9faì™€ ë§ì¶¤) */
        .history-item:hover:not(.active) .delete-overlay {
            background: linear-gradient(to right, rgba(248, 249, 250, 0), rgba(248, 249, 250, 1) 40%);
        }

        /* Hover ì‹œ ì˜¤ë²„ë ˆì´ ë³´ì´ê¸° */
        .history-item:hover .delete-overlay {
            opacity: 1;
        }

        /* ë‘¥ê·¼ X ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-delete-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #ff4d4d;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s, background 0.2s;
            margin-right: 10px; /* ìš°ì¸¡ ì—¬ë°± */
        }
        .btn-delete-circle:hover {
            background-color: #d32f2f;
            transform: scale(1.1);
        }

        .history-date { font-size: 11px; color: #888; margin-bottom: 4px; }
        .history-title { font-size: 13px; font-weight: 600; color: #333; line-height: 1.4; word-break: break-all; }

        /* --- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ --- */
        .main-content {
            height: 100vh; padding: 20px; box-sizing: border-box; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        h2 { text-align: center; color: #333; margin-top: 10px; margin-bottom: 20px; }
        
        .controls { 
            text-align: center; margin-bottom: 20px; padding: 15px; 
            background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .controls label { margin-right: 15px; cursor: pointer; font-weight: 600; font-size: 14px; user-select: none; }
        .controls input[type="checkbox"] { margin-right: 5px; transform: scale(1.2); vertical-align: middle; }
        
        .btn { 
            padding: 8px 20px; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; margin-left: 5px;
            transition: background 0.2s;
        }
        .btn-primary { background-color: #0069d9; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; }

        .description-container { margin-bottom: 10px; }
        .desc-input {
            width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc;
            border-radius: 4px; font-size: 14px; font-family: 'Segoe UI', sans-serif; background-color: #fff;
        }
        .desc-input:focus { outline: none; border-color: #0069d9; box-shadow: 0 0 0 2px rgba(0,105,217, 0.2); }

        .input-container { display: flex; gap: 10px; min-height: 200px; margin-bottom: 20px; }
        .input-box { flex: 1; display: flex; flex-direction: column; }
        .input-box h3 { margin: 0 0 5px 0; font-size: 14px; color: #555; }
        textarea { 
            flex: 1; padding: 10px; font-family: monospace; border: 1px solid #ccc; 
            border-radius: 4px; resize: vertical; font-size: 12px; min-height: 150px;
        }

        #result-container { 
            display: none; width: 100%; border: 1px solid #ddd; background: white; 
            font-family: Consolas, "Courier New", monospace; font-size: 12px; line-height: 1.5;
            margin-bottom: 50px;
        }

        .diff-row { display: flex; border-bottom: 1px solid #f0f0f0; }
        .cell { flex: 1; padding: 2px 5px; white-space: pre-wrap; word-break: break-all; position: relative; }
        .cell-left { border-right: 1px solid #ddd; }
        .bg-white { background-color: #fff; color: #333; }
        .bg-diff { background-color: #ffeef0; color: #d10000; font-weight: bold; }
        .bg-empty {
            background: repeating-linear-gradient(45deg, #fcfcfc, #fcfcfc 10px, #f0f0f0 10px, #f0f0f0 20px);
            color: transparent; user-select: none;
        }
    </style>
</head>
<body>

    <button class="history-toggle-btn" id="btn-toggle-history" onclick="toggleSidebar(event)">
        <span>ğŸ•’ íˆìŠ¤í† ë¦¬</span>
    </button>

    <aside class="sidebar" id="history-sidebar" onclick="event.stopPropagation()">
        <div class="sidebar-header">
            <h3>History List</h3>
            <button class="btn-close-sidebar" onclick="closeSidebar()">&times;</button>
        </div>
        <div style="padding: 0 20px;">
            <button class="btn-clear" onclick="clearAllHistory()">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
        </div>
        <ul id="history-list" class="history-list">
            </ul>
    </aside>

    <main class="main-content" onclick="closeSidebar()">
        <h2>JSON Smart Diff</h2>

        <div class="controls">
            <label><input type="checkbox" id="chk-remove-null"> Null ê°’ ì‚­ì œ</label>
            <label><input type="checkbox" id="chk-sort-keys" checked> í‚¤ ì •ë ¬ (í•„ìˆ˜)</label>
            <label style="color: #d10000;"><input type="checkbox" id="chk-diff-only"> <strong>ë‹¤ë¥¸ ë¶€ë¶„ë§Œ ë³´ê¸°</strong></label>
            
            <span style="display:inline-block; width: 20px;"></span>
            
            <button class="btn btn-secondary" onclick="swapInputs()">â†” ì¢Œìš° ì „í™˜</button>
            <button class="btn btn-primary" onclick="compareJson()">ë¹„êµ ì‹¤í–‰</button>
        </div>

        <div class="description-container">
            <input type="text" id="diff-description" class="desc-input" placeholder="ì„¤ëª…... (ì˜ˆ: 12/01 ìš´ì˜ ë°°í¬ ì „ ë°ì´í„° ë¹„êµ)">
        </div>

        <div class="input-container">
            <div class="input-box">
                <h3>Left (Original)</h3>
                <textarea id="json-input-left" placeholder='{"left": "206"}'></textarea>
            </div>
            <div class="input-box">
                <h3>Right (Changed)</h3>
                <textarea id="json-input-right" placeholder='{"isModifyMode": true}'></textarea>
            </div>
        </div>

        <div id="result-container"></div>
    </main>

<script>
    function toggleSidebar(e) {
        e.stopPropagation();
        const sidebar = document.getElementById('history-sidebar');
        sidebar.classList.toggle('open');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('history-sidebar');
        sidebar.classList.remove('open');
    }

    const STORAGE_KEY = 'json_diff_history_final'; 
    let historyData = [];

    window.onload = function() {
        loadHistory();
    };

    function loadHistory() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                historyData = JSON.parse(stored);
            } catch(e) { historyData = []; }
        }
        renderHistoryList();

        // ìë™ ë³µêµ¬ ë¡œì§ (ê°€ì¥ ìµœê·¼ ê²ƒ)
        if (historyData.length > 0) {
            const lastItem = historyData[0];
            document.getElementById('json-input-left').value = lastItem.left;
            document.getElementById('json-input-right').value = lastItem.right;
            document.getElementById('diff-description').value = lastItem.description || "";
            compareJson(true);
        }
    }

    function getJsonSnippet(jsonStr) {
        if (!jsonStr) return "Empty";
        try {
            const minified = jsonStr.replace(/\s/g, "");
            const limit = 40;
            if (minified.length > limit) return minified.substring(0, limit) + "...";
            return minified;
        } catch (e) { return "Data..."; }
    }

    function saveToHistory(left, right) {
        if (!left.trim() && !right.trim()) return;
        const descInput = document.getElementById('diff-description').value.trim();

        if (historyData.length > 0) {
            const last = historyData[0];
            if (last.left === left && last.right === right && last.description === descInput) return;
        }

        let displayTitle = "";
        if (descInput) {
            displayTitle = descInput;
        } else {
            const lSum = getJsonSnippet(left);
            const rSum = getJsonSnippet(right);
            displayTitle = `<span style="font-family:monospace; color:#555;">${lSum}</span><br>â¬‡<br><span style="font-family:monospace; color:#0069d9;">${rSum}</span>`;
        }

        const newItem = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            title: displayTitle,
            description: descInput,
            left: left,
            right: right
        };

        historyData.unshift(newItem);
        if (historyData.length > 50) historyData.pop();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        renderHistoryList();
    }

    // [í•µì‹¬] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ìˆ˜ì • (Overlay + X ë²„íŠ¼ ì¶”ê°€)
    function renderHistoryList() {
        const listEl = document.getElementById('history-list');
        listEl.innerHTML = '';

        historyData.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'history-item';
            // ê¸°ë³¸ í´ë¦­: ë³µì›
            li.onclick = () => { restoreHistory(index); closeSidebar(); };
            
            li.innerHTML = `
                <div class="history-date">${item.date}</div>
                <div class="history-title">${item.title}</div>
                
                <div class="delete-overlay">
                    <button class="btn-delete-circle" onclick="deleteHistoryItem(${index}, event)">
                        &times;
                    </button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    function restoreHistory(index) {
        const item = historyData[index];
        if (!item) return;

        const items = document.querySelectorAll('.history-item');
        items.forEach(el => el.classList.remove('active'));
        items[index].classList.add('active');

        document.getElementById('json-input-left').value = item.left;
        document.getElementById('json-input-right').value = item.right;
        document.getElementById('diff-description').value = item.description || "";

        compareJson(true);
    }

    // [ì¶”ê°€] ê°œë³„ ì•„ì´í…œ ì‚­ì œ í•¨ìˆ˜
    function deleteHistoryItem(index, event) {
        event.stopPropagation(); // ë¶€ëª¨(li)ì˜ onclick ì´ë²¤íŠ¸(ë³µì›) ë°©ì§€
        
		historyData.splice(index, 1); // ë°°ì—´ì—ì„œ ì œê±°
		localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData)); // ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
		renderHistoryList(); // ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    function clearAllHistory() {
        if (confirm('ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            historyData = [];
            localStorage.removeItem(STORAGE_KEY);
            renderHistoryList();
        }
    }

    // --- Diff Logic (ìœ ì§€) ---
    function swapInputs() {
        const leftEl = document.getElementById('json-input-left');
        const rightEl = document.getElementById('json-input-right');
        const temp = leftEl.value;
        leftEl.value = rightEl.value;
        rightEl.value = temp;
        if (leftEl.value.trim() !== "" || rightEl.value.trim() !== "") compareJson();
    }

    function removeNulls(obj) {
        if (Array.isArray(obj)) return obj.map(v => removeNulls(v)).filter(v => v !== null);
        if (typeof obj === 'object' && obj !== null) {
            return Object.keys(obj).reduce((acc, key) => {
                const val = removeNulls(obj[key]);
                if (val !== null) acc[key] = val;
                return acc;
            }, {});
        }
        return obj;
    }

    function sortObject(obj) {
        if (Array.isArray(obj)) return obj.map(sortObject);
        if (typeof obj === 'object' && obj !== null) {
            return Object.keys(obj).sort().reduce((acc, key) => {
                acc[key] = sortObject(obj[key]);
                return acc;
            }, {});
        }
        return obj;
    }

    function getIndentLevel(str) {
        const match = str.match(/^(\s*)/);
        return match ? match[0].length : 0;
    }

    function extractKey(str) {
        const match = str.match(/^\s*"([^"]+)"\s*:/);
        return match ? match[1] : null;
    }

    function compareJson(isRestoreFromHistory = false) {
        const leftRaw = document.getElementById('json-input-left').value;
        const rightRaw = document.getElementById('json-input-right').value;
        
        if (!isRestoreFromHistory) {
            saveToHistory(leftRaw, rightRaw);
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        }

        const removeNullOption = document.getElementById('chk-remove-null').checked;
        const sortKeyOption = document.getElementById('chk-sort-keys').checked;
        const diffOnlyOption = document.getElementById('chk-diff-only').checked;
        const resultContainer = document.getElementById('result-container');

        let leftObj, rightObj;
        try {
            leftObj = JSON.parse(leftRaw || "{}");
            rightObj = JSON.parse(rightRaw || "{}");
        } catch (e) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = `<div style="padding:20px; color:red;">JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}</div>`;
            return;
        }

        if (removeNullOption) { leftObj = removeNulls(leftObj); rightObj = removeNulls(rightObj); }
        if (sortKeyOption) { leftObj = sortObject(leftObj); rightObj = sortObject(rightObj); }

        const leftStr = JSON.stringify(leftObj, null, 4);
        const rightStr = JSON.stringify(rightObj, null, 4);
        const diff = Diff.diffLines(leftStr, rightStr);
        
        let allRows = [], leftBuffer = [], rightBuffer = [];

        function flushToRows() {
            let lIndex = 0, rIndex = 0;
            while (lIndex < leftBuffer.length || rIndex < rightBuffer.length) {
                const lItem = leftBuffer[lIndex], rItem = rightBuffer[rIndex];
                const lKey = lItem ? extractKey(lItem.text) : null;
                const rKey = rItem ? extractKey(rItem.text) : null;
                let pushLeft = false, pushRight = false;

                if (lItem && rItem) {
                    if (lKey && rKey) {
                        if (lKey === rKey) { pushLeft = true; pushRight = true; } 
                        else if (lKey < rKey) { pushLeft = true; } 
                        else { pushRight = true; }
                    } else { pushLeft = true; pushRight = true; }
                } else if (lItem) { pushLeft = true; } 
                else if (rItem) { pushRight = true; }

                const lData = pushLeft ? lItem : { text: "", type: "bg-empty" };
                const rData = pushRight ? rItem : { text: "", type: "bg-empty" };
                const mainText = (lData.type !== "bg-empty") ? lData.text : rData.text;
                allRows.push({
                    left: lData, right: rData, indent: getIndentLevel(mainText),
                    isDiff: (lData.type === 'bg-diff' || rData.type === 'bg-diff'),
                    textForContext: mainText
                });

                if (pushLeft) lIndex++;
                if (pushRight) rIndex++;
            }
            leftBuffer = []; rightBuffer = [];
        }

        diff.forEach((part) => {
            const lines = part.value.split('\n');
            if (lines[lines.length - 1] === '') lines.pop();
            if (part.added) lines.forEach(l => rightBuffer.push({ text: l, type: 'bg-diff' }));
            else if (part.removed) lines.forEach(l => leftBuffer.push({ text: l, type: 'bg-diff' }));
            else {
                flushToRows();
                lines.forEach(l => {
                    allRows.push({
                        left: { text: l, type: 'bg-white' }, right: { text: l, type: 'bg-white' },
                        indent: getIndentLevel(l), isDiff: false, textForContext: l
                    });
                });
            }
        });
        flushToRows();

        let visibleIndices = new Set();
        if (!diffOnlyOption) allRows.forEach((_, idx) => visibleIndices.add(idx));
        else {
            allRows.forEach((row, idx) => { if (row.isDiff) visibleIndices.add(idx); });
            let sortedIndices = [...visibleIndices].sort((a, b) => a - b);
            sortedIndices.forEach(index => {
                let currentIndent = allRows[index].indent;
                for (let i = index - 1; i >= 0; i--) {
                    const row = allRows[i];
                    if (row.indent < currentIndent) { visibleIndices.add(i); currentIndent = row.indent; }
                    if (currentIndent === 0) break;
                }
            });
            [...visibleIndices].forEach(index => {
                const row = allRows[index];
                if (row.textForContext.includes('{') || row.textForContext.includes('[')) {
                    for (let i = index + 1; i < allRows.length; i++) {
                        const nextRow = allRows[i];
                        if (nextRow.indent < row.indent) break; 
                        if (nextRow.indent === row.indent) {
                            const t = nextRow.textForContext.trim();
                            if (t.startsWith('}') || t.startsWith(']')) { visibleIndices.add(i); break; }
                        }
                    }
                }
            });
        }

        resultContainer.innerHTML = '';
        resultContainer.style.display = 'block';

        const sortedVisible = [...visibleIndices].sort((a, b) => a - b);
        if (sortedVisible.length === 0) {
            resultContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">ì°¨ì´ì ì´ ì—†ê±°ë‚˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
            return;
        }

        sortedVisible.forEach(index => {
            const rowData = allRows[index];
            const rowEl = document.createElement('div');
            rowEl.className = 'diff-row';
            const leftCell = document.createElement('div');
            leftCell.className = `cell cell-left ${rowData.left.type}`;
            leftCell.textContent = rowData.left.text;
            const rightCell = document.createElement('div');
            rightCell.className = `cell cell-right ${rowData.right.type}`;
            rightCell.textContent = rowData.right.text;
            rowEl.appendChild(leftCell); rowEl.appendChild(rightCell);
            resultContainer.appendChild(rowEl);
        });
    }
</script>
</body>
</html>
