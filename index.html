<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Smart Diff (Align & Un-align)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ìœ ì§€) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; height: 100vh; overflow: hidden; }
        
        .sidebar {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100vh;
            background-color: #ffffff; border-right: 1px solid #ddd;
            display: flex; flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 1000;
            transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .sidebar.open { left: 0; }
        .history-toggle-btn {
            position: absolute; top: 20px; left: 20px; z-index: 500;
            background-color: #343a40; color: white; border: none; padding: 10px 15px;
            border-radius: 30px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .history-toggle-btn:hover { background-color: #23272b; transform: scale(1.05); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; background-color: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { margin: 0; font-size: 18px; color: #333; }
        .btn-close-sidebar { background: none; border: none; font-size: 20px; cursor: pointer; color: #888; }
        .btn-clear { margin-top: 10px; width: 100%; padding: 8px; font-size: 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .history-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .history-item { position: relative; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; overflow: hidden; }
        .history-item:hover { background-color: #f8f9fa; }
        .history-item.active { background-color: #e7f1ff; border-left: 4px solid #0069d9; }
        .delete-overlay { position: absolute; top: 0; right: 0; bottom: 0; width: 80px; background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,1) 40%); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease-in-out; padding-left: 20px; }
        .history-item:hover .delete-overlay { opacity: 1; }
        .btn-delete-circle { width: 28px; height: 28px; border-radius: 50%; background-color: #ff4d4d; color: white; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s, background 0.2s; margin-right: 10px; }
        .history-date { font-size: 11px; color: #888; margin-bottom: 4px; }
        .history-title { font-size: 13px; font-weight: 600; color: #333; line-height: 1.4; word-break: break-all; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { height: 100vh; padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; }
        h2 { text-align: center; color: #333; margin-top: 10px; margin-bottom: 20px; }
        .controls { text-align: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls label { margin-right: 15px; cursor: pointer; font-weight: 600; font-size: 14px; user-select: none; }
        .controls input[type="checkbox"] { margin-right: 5px; transform: scale(1.2); vertical-align: middle; }
        .btn { padding: 8px 20px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; margin-left: 5px; transition: background 0.2s; }
        .btn-primary { background-color: #0069d9; }
        .btn-secondary { background-color: #6c757d; }
        .btn-outline { background-color: white; border: 1px solid #ccc; color: #333; }
        .btn-outline:hover { background-color: #f8f9fa; }
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .desc-input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; margin-bottom: 10px; }
        .input-container { display: flex; gap: 10px; min-height: 200px; margin-bottom: 20px; }
        .input-box { flex: 1; display: flex; flex-direction: column; }
        .input-box h3 { margin: 0 0 5px 0; font-size: 14px; color: #555; }
        textarea { flex: 1; padding: 10px; font-family: monospace; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-size: 12px; min-height: 150px; }
        #result-container { display: none; width: 100%; border: 1px solid #ddd; background: white; font-family: Consolas, "Courier New", monospace; font-size: 12px; line-height: 1.5; margin-bottom: 50px; }

        .diff-row { display: flex; border-bottom: 1px solid #f0f0f0; }
        .cell { flex: 1; padding: 2px 5px; white-space: pre-wrap; word-break: break-all; position: relative; cursor: pointer; }
        .cell:hover { background-color: #f1f3f5; }
        .cell-left { border-right: 1px solid #ddd; }
        .bg-white { background-color: #fff; color: #333; }
        .bg-diff { background-color: #ffeef0; color: #d10000; font-weight: bold; }
        .bg-empty { background: repeating-linear-gradient(45deg, #fcfcfc, #fcfcfc 10px, #f0f0f0 10px, #f0f0f0 20px); color: transparent; user-select: none; cursor: default; }
        .cell.selected { background-color: #fff3cd !important; outline: 2px solid #ffc107; z-index: 10; }
        
        /* ê°•ì œ ì •ë ¬ëœ ì¤„ ìŠ¤íƒ€ì¼ */
        .diff-row.forced-aligned { background-color: #e8f5e9; border-top: 1px solid #4caf50; border-bottom: 1px solid #4caf50; }
        .diff-row.forced-aligned .cell { font-weight: bold; color: #2e7d32; }
        /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ í•´ì œ ê°€ëŠ¥í•¨ì„ í‘œì‹œ */
        .diff-row.forced-aligned .cell:hover { background-color: #ffcdd2; color: #d32f2f; }
        .diff-row.forced-aligned .cell:hover::after {
            content: " (í´ë¦­í•˜ì—¬ í•´ì œ)"; font-size: 10px; opacity: 0.7;
        }
        
        .align-info { text-align: center; font-size: 13px; color: #0069d9; margin-bottom: 10px; font-weight: bold; }
        .shortcut-tip { font-size: 11px; color: #666; font-weight: normal; margin-left: 10px; }
    </style>
</head>
<body>

    <button class="history-toggle-btn" onclick="toggleSidebar(event)"><span>ğŸ•’ íˆìŠ¤í† ë¦¬</span></button>

    <aside class="sidebar" id="history-sidebar" onclick="event.stopPropagation()">
        <div class="sidebar-header"><h3>History List</h3><button class="btn-close-sidebar" onclick="closeSidebar()">&times;</button></div>
        <div style="padding: 0 20px;"><button class="btn-clear" onclick="clearAllHistory()">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button></div>
        <ul id="history-list" class="history-list"></ul>
    </aside>

    <main class="main-content" onclick="closeSidebar()">
        <h2>JSON Smart Diff</h2>

        <div class="controls">
            <label><input type="checkbox" id="chk-remove-null"> Null ê°’ ì‚­ì œ</label>
            <label><input type="checkbox" id="chk-sort-keys" checked> í‚¤ ì •ë ¬ (í•„ìˆ˜)</label>
            <label style="color: #d10000;"><input type="checkbox" id="chk-diff-only"> <strong>ë‹¤ë¥¸ ë¶€ë¶„ë§Œ ë³´ê¸°</strong></label>
            <span style="display:inline-block; width: 20px;"></span>
            <button class="btn btn-secondary" onclick="swapInputs()">â†” ì¢Œìš° ì „í™˜</button>
            <button class="btn btn-primary" onclick="initCompare()">ë¹„êµ ì‹¤í–‰</button>
            <button class="btn btn-warning" onclick="undoAlignment()" id="btn-undo" style="display:none;">â†© ë˜ëŒë¦¬ê¸° (Ctrl+Z)</button>
            <button class="btn btn-outline" onclick="resetAlignment()" id="btn-reset-align" style="display:none;">ì •ë ¬ ì´ˆê¸°í™”</button>
        </div>

        <div style="margin-bottom:10px;">
            <input type="text" id="diff-description" class="desc-input" placeholder="ì„¤ëª…... ">
        </div>
        
        <div id="align-msg" class="align-info"></div>

        <div class="input-container">
            <div class="input-box"><h3>Left (Original)</h3><textarea id="json-input-left" placeholder='{"left": "206"}'></textarea></div>
            <div class="input-box"><h3>Right (Changed)</h3><textarea id="json-input-right" placeholder='{"isModifyMode": true}'></textarea></div>
        </div>
        <div id="result-container"></div>
    </main>

<script>
    // --- ìœ í‹¸ë¦¬í‹° ë° íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ---
    function toggleSidebar(e) { e.stopPropagation(); document.getElementById('history-sidebar').classList.toggle('open'); }
    function closeSidebar() { document.getElementById('history-sidebar').classList.remove('open'); }
    const STORAGE_KEY = 'json_diff_history_final_v3'; 
    let historyData = [];

    window.onload = function() { loadHistory(); };
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undoAlignment(); }
    });

    function loadHistory() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) { try { historyData = JSON.parse(stored); } catch(e) { historyData = []; } }
        renderHistoryList();
        if (historyData.length > 0) {
            const lastItem = historyData[0];
            document.getElementById('json-input-left').value = lastItem.left;
            document.getElementById('json-input-right').value = lastItem.right;
            document.getElementById('diff-description').value = lastItem.description || "";
            initCompare(true);
        }
    }
    function saveToHistory(left, right) {
        if (!left.trim() && !right.trim()) return;
        const descInput = document.getElementById('diff-description').value.trim();
        if (historyData.length > 0) {
            const last = historyData[0];
            if (last.left === left && last.right === right && last.description === descInput) return;
        }
        const displayTitle = descInput || "JSON Diff";
        historyData.unshift({ id: Date.now(), date: new Date().toLocaleString(), title: displayTitle, description: descInput, left, right });
        if (historyData.length > 50) historyData.pop();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        renderHistoryList();
    }
    function renderHistoryList() {
        const listEl = document.getElementById('history-list');
        listEl.innerHTML = '';
        historyData.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.onclick = () => { restoreHistory(index); closeSidebar(); };
            li.innerHTML = `<div class="history-date">${item.date}</div><div class="history-title">${item.title}</div><div class="delete-overlay"><button class="btn-delete-circle" onclick="deleteHistoryItem(${index}, event)">&times;</button></div>`;
            listEl.appendChild(li);
        });
    }
    function restoreHistory(index) {
        const item = historyData[index];
        if (!item) return;
        document.getElementById('json-input-left').value = item.left;
        document.getElementById('json-input-right').value = item.right;
        document.getElementById('diff-description').value = item.description || "";
        initCompare(true);
    }
    function deleteHistoryItem(index, event) {
        event.stopPropagation();
        historyData.splice(index, 1);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
        renderHistoryList();
    }
    function clearAllHistory() {
        if (confirm('ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { historyData = []; localStorage.removeItem(STORAGE_KEY); renderHistoryList(); }
    }
    function swapInputs() {
        const leftEl = document.getElementById('json-input-left');
        const rightEl = document.getElementById('json-input-right');
        const temp = leftEl.value; leftEl.value = rightEl.value; rightEl.value = temp;
        if (leftEl.value.trim() !== "") initCompare();
    }
    function removeNulls(obj) {
        if (Array.isArray(obj)) return obj.map(v => removeNulls(v)).filter(v => v !== null);
        if (typeof obj === 'object' && obj !== null) return Object.keys(obj).reduce((acc, key) => { const val = removeNulls(obj[key]); if (val !== null) acc[key] = val; return acc; }, {});
        return obj;
    }
    function sortObject(obj) {
        if (Array.isArray(obj)) return obj.map(sortObject);
        if (typeof obj === 'object' && obj !== null) return Object.keys(obj).sort().reduce((acc, key) => { acc[key] = sortObject(obj[key]); return acc; }, {});
        return obj;
    }
    function getIndentLevel(str) { return (str.match(/^(\s*)/) || [""])[0].length; }
    function extractKey(str) { const match = str.match(/^\s*"([^"]+)"\s*:/); return match ? match[1] : null; }

    // --- í•µì‹¬ ë¡œì§ (Undo Stack + Un-align) ---

    let gLeftLines = [];  
    let gRightLines = []; 
    let gSelection = { left: null, right: null }; 
    let gAlignments = []; 
    let gUndoStack = []; // Undoë¥¼ ìœ„í•œ ìƒíƒœ ìŠ¤íƒ

    function initCompare(isRestoreFromHistory = false) {
        resetSelectionState(true);
        const leftRaw = document.getElementById('json-input-left').value;
        const rightRaw = document.getElementById('json-input-right').value;
        
        if (!isRestoreFromHistory) {
            saveToHistory(leftRaw, rightRaw);
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        }

        const removeNullOption = document.getElementById('chk-remove-null').checked;
        const sortKeyOption = document.getElementById('chk-sort-keys').checked;
        const resultContainer = document.getElementById('result-container');

        let leftObj, rightObj;
        try {
            leftObj = JSON.parse(leftRaw || "{}");
            rightObj = JSON.parse(rightRaw || "{}");
        } catch (e) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = `<div style="padding:20px; color:red;">JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}</div>`;
            return;
        }

        if (removeNullOption) { leftObj = removeNulls(leftObj); rightObj = removeNulls(rightObj); }
        if (sortKeyOption) { leftObj = sortObject(leftObj); rightObj = sortObject(rightObj); }

        gLeftLines = JSON.stringify(leftObj, null, 4).split('\n');
        gRightLines = JSON.stringify(rightObj, null, 4).split('\n');

        performDiffAndRender();
    }

    function resetSelectionState(fullReset = false) {
        gSelection = { left: null, right: null };
        if (fullReset) {
            gAlignments = [];
            gUndoStack = [];
        }
        updateControlButtons();
    }

    function resetAlignment() { initCompare(true); }

    // [ì¤‘ìš”] ìƒíƒœ ì €ì¥: í˜„ì¬ gAlignmentsì˜ ë³µì‚¬ë³¸ì„ ìŠ¤íƒì— ì €ì¥
    function saveStateToUndoStack() {
        // ë°°ì—´ ì•ˆì˜ ê°ì²´ë„ ë³µì‚¬í•˜ê¸° ìœ„í•´ Deep Copy í˜¹ì€ mapìœ¼ë¡œ ìƒˆ ê°ì²´ ìƒì„±
        const currentSnapshot = gAlignments.map(a => ({...a}));
        gUndoStack.push(currentSnapshot);
    }

    function undoAlignment() {
        if (gUndoStack.length === 0) return;
        const prevState = gUndoStack.pop();
        gAlignments = prevState;
        gSelection = { left: null, right: null }; // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        performDiffAndRender();
    }

    function updateControlButtons() {
        const hasHistory = gUndoStack.length > 0;
        const hasAlignments = gAlignments.length > 0;
        
        document.getElementById('btn-reset-align').style.display = hasAlignments ? 'inline-block' : 'none';
        document.getElementById('btn-undo').style.display = hasHistory ? 'inline-block' : 'none';
        
        const msg = document.getElementById('align-msg');
        if (hasAlignments) {
            msg.innerHTML = `í˜„ì¬ <strong>${gAlignments.length}</strong>ê°œì˜ ì¤„ì´ ì •ë ¬ë¨. <span style="color:#2e7d32">ì´ˆë¡ìƒ‰ ì¤„</span>ì„ í´ë¦­í•˜ë©´ ì •ë ¬ì´ í•´ì œë©ë‹ˆë‹¤. <span class="shortcut-tip">(Ctrl+Z ì‹¤í–‰ì·¨ì†Œ)</span>`;
        } else {
            msg.innerHTML = `ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ì—ì„œ ë§ì¶”ê³  ì‹¶ì€ ì¤„ì„ ê°ê° í´ë¦­í•˜ì„¸ìš”. <span class="shortcut-tip">â€» Ctrl + Z ë¡œ ë˜ëŒë¦¬ê¸° ê°€ëŠ¥</span>`;
        }
    }

    function performDiffAndRender() {
        updateControlButtons();
        const diffOnlyOption = document.getElementById('chk-diff-only').checked;
        let allDisplayRows = []; 

        gAlignments.sort((a, b) => a.left - b.left);

        let prevL = 0;
        let prevR = 0;

        gAlignments.forEach(align => {
            const currentL = align.left;
            const currentR = align.right;

            // Chunk Diff
            if (currentL > prevL || currentR > prevR) {
                const chunkL = gLeftLines.slice(prevL, currentL).join('\n');
                const chunkR = gRightLines.slice(prevR, currentR).join('\n');
                const diffChunk = Diff.diffLines(chunkL, chunkR);
                allDisplayRows = allDisplayRows.concat(generateRowsFromDiff(diffChunk, prevL, prevR));
            }

            // Forced Row
            const alignedRow = {
                left: { text: gLeftLines[currentL], type: 'bg-white', lineIndex: currentL },
                right: { text: gRightLines[currentR], type: 'bg-white', lineIndex: currentR },
                indent: getIndentLevel(gLeftLines[currentL]),
                isDiff: gLeftLines[currentL] !== gRightLines[currentR],
                textForContext: gLeftLines[currentL],
                isForced: true 
            };
            if (alignedRow.isDiff) {
                alignedRow.left.type = 'bg-diff';
                alignedRow.right.type = 'bg-diff';
            }
            allDisplayRows.push(alignedRow);

            prevL = currentL + 1;
            prevR = currentR + 1;
        });

        // Tail Diff
        if (prevL < gLeftLines.length || prevR < gRightLines.length) {
            const tailL = gLeftLines.slice(prevL).join('\n');
            const tailR = gRightLines.slice(prevR).join('\n');
            const diffTail = Diff.diffLines(tailL, tailR);
            allDisplayRows = allDisplayRows.concat(generateRowsFromDiff(diffTail, prevL, prevR));
        }

        renderRowsToDOM(allDisplayRows, diffOnlyOption);
    }

    function generateRowsFromDiff(diffData, startLeftLineIdx, startRightLineIdx) {
        let rows = [];
        let leftBuffer = [], rightBuffer = [];
        let curL = startLeftLineIdx;
        let curR = startRightLineIdx;

        function flush() {
            let lI = 0, rI = 0;
            while (lI < leftBuffer.length || rI < rightBuffer.length) {
                const lItem = leftBuffer[lI];
                const rItem = rightBuffer[rI];
                const lKey = lItem ? extractKey(lItem.text) : null;
                const rKey = rItem ? extractKey(rItem.text) : null;
                
                let pushLeft = false, pushRight = false;
                if (lItem && rItem) {
                    if (lKey && rKey) {
                        if (lKey === rKey) { pushLeft = true; pushRight = true; }
                        else if (lKey < rKey) { pushLeft = true; }
                        else { pushRight = true; }
                    } else { pushLeft = true; pushRight = true; }
                } else if (lItem) { pushLeft = true; }
                else if (rItem) { pushRight = true; }

                const lData = pushLeft ? lItem : { text: "", type: "bg-empty", lineIndex: -1 };
                const rData = pushRight ? rItem : { text: "", type: "bg-empty", lineIndex: -1 };
                
                rows.push({
                    left: lData, right: rData,
                    indent: getIndentLevel(lData.text || rData.text),
                    isDiff: (lData.type === 'bg-diff' || rData.type === 'bg-diff'),
                    textForContext: lData.text || rData.text
                });

                if (pushLeft) lI++;
                if (pushRight) rI++;
            }
            leftBuffer = []; rightBuffer = [];
        }

        diffData.forEach(part => {
            let lines = part.value.split('\n');
            if (lines.length > 0 && lines[lines.length - 1] === '') lines.pop();

            if (part.added) {
                lines.forEach(l => rightBuffer.push({ text: l, type: 'bg-diff', lineIndex: curR++ }));
            } else if (part.removed) {
                lines.forEach(l => leftBuffer.push({ text: l, type: 'bg-diff', lineIndex: curL++ }));
            } else {
                flush(); 
                lines.forEach(l => {
                    rows.push({
                        left: { text: l, type: 'bg-white', lineIndex: curL++ },
                        right: { text: l, type: 'bg-white', lineIndex: curR++ },
                        indent: getIndentLevel(l), isDiff: false, textForContext: l
                    });
                });
            }
        });
        flush();
        return rows;
    }

    function renderRowsToDOM(allRows, diffOnlyOption) {
        const resultContainer = document.getElementById('result-container');
        let visibleIndices = new Set();

        if (!diffOnlyOption) {
            allRows.forEach((_, idx) => visibleIndices.add(idx));
        } else {
            allRows.forEach((row, idx) => { if (row.isDiff) visibleIndices.add(idx); });
            let sortedIndices = [...visibleIndices].sort((a, b) => a - b);
            sortedIndices.forEach(index => {
                let currentIndent = allRows[index].indent;
                for (let i = index - 1; i >= 0; i--) {
                    const row = allRows[i];
                    if (row.indent < currentIndent) { visibleIndices.add(i); currentIndent = row.indent; }
                    if (currentIndent === 0) break;
                }
            });
            [...visibleIndices].forEach(index => {
                const row = allRows[index];
                if (row.textForContext.includes('{') || row.textForContext.includes('[')) {
                    for (let i = index + 1; i < allRows.length; i++) {
                        const nextRow = allRows[i];
                        if (nextRow.indent < row.indent) break; 
                        if (nextRow.indent === row.indent) {
                            const t = nextRow.textForContext.trim();
                            if (t.startsWith('}') || t.startsWith(']')) { visibleIndices.add(i); break; }
                        }
                    }
                }
            });
        }

        resultContainer.innerHTML = '';
        resultContainer.style.display = 'block';

        const sortedVisible = [...visibleIndices].sort((a, b) => a - b);
        if (sortedVisible.length === 0) {
            resultContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">ì°¨ì´ì ì´ ì—†ê±°ë‚˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
            return;
        }

        sortedVisible.forEach(index => {
            const rowData = allRows[index];
            const rowEl = document.createElement('div');
            rowEl.className = 'diff-row';
            if (rowData.isForced) rowEl.classList.add('forced-aligned');

            const leftCell = createCell(rowData.left, 'left');
            const rightCell = createCell(rowData.right, 'right');
            
            rowEl.appendChild(leftCell); 
            rowEl.appendChild(rightCell);
            resultContainer.appendChild(rowEl);
        });
    }

    function createCell(data, side) {
        const div = document.createElement('div');
        div.className = `cell cell-${side} ${data.type}`;
        div.textContent = data.text;
        
        if (data.lineIndex !== -1) {
            div.onclick = function() { handleCellClick(side, data.lineIndex, div); };
            if (side === 'left' && gSelection.left === data.lineIndex) div.classList.add('selected');
            if (side === 'right' && gSelection.right === data.lineIndex) div.classList.add('selected');
        } else {
            div.style.cursor = 'default';
        }
        return div;
    }

    function handleCellClick(side, lineIndex, el) {
        // [ê¸°ëŠ¥ ì¶”ê°€] ì´ë¯¸ ì •ë ¬ëœ ì¤„(ë…¹ìƒ‰)ì„ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸ -> í•´ì œ ë¡œì§
        const existingAlignIndex = gAlignments.findIndex(align => 
            (side === 'left' && align.left === lineIndex) || 
            (side === 'right' && align.right === lineIndex)
        );

        if (existingAlignIndex !== -1) {
            // ì •ë ¬ í•´ì œ ë¡œì§
            saveStateToUndoStack(); // í•´ì œ ì „ ìƒíƒœ ì €ì¥ (Undo ê°€ëŠ¥í•˜ë„ë¡)
            gAlignments.splice(existingAlignIndex, 1); // ë°°ì—´ì—ì„œ ì œê±°
            gSelection = { left: null, right: null }; // í˜¹ì‹œ ëª¨ë¥¼ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            performDiffAndRender();
            return;
        }

        // --- ì´í•˜ ê¸°ì¡´ ì„ íƒ ë¡œì§ ---
        if (gSelection[side] === lineIndex) {
            gSelection[side] = null;
            el.classList.remove('selected');
            return;
        }
        
        const oldSelected = document.querySelectorAll(`.cell-${side}.selected`);
        oldSelected.forEach(cell => cell.classList.remove('selected'));

        gSelection[side] = lineIndex;
        el.classList.add('selected');

        if (gSelection.left !== null && gSelection.right !== null) {
            setTimeout(() => {
                saveStateToUndoStack(); // ì •ë ¬ ì¶”ê°€ ì „ ìƒíƒœ ì €ì¥
                gAlignments.push({ left: gSelection.left, right: gSelection.right });
                gSelection = { left: null, right: null };
                performDiffAndRender();
            }, 50);
        }
    }
</script>
</body>
</html>
